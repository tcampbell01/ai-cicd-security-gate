name: Security Gate (Python SAST + SCA + Secrets)

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: write

jobs:
  security-gate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install bandit pip-audit pyyaml requests

      # ---------- Bandit (SAST for Python) ----------
      - name: Run Bandit (SAST)
        run: |
          bandit -r . --exclude ./venv -f json -o bandit.json || true

      # ---------- pip-audit (SCA for Python deps) ----------
      - name: Run pip-audit (Dependencies)
        run: |
          pip-audit -f json -o pip-audit.json || true

      # ---------- Gitleaks (Secrets) ----------
      - name: Install Gitleaks
        run: |
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.24.3/gitleaks_8.24.3_linux_x64.tar.gz
          tar -xzf gitleaks_8.24.3_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/
          
      - name: Run Gitleaks (Secrets)
        run: |
          gitleaks detect --source . --report-format json --report-path gitleaks.json || true

      # ---------- Gate (Policy Enforcement) ----------
      - name: Enforce Security Gate
        id: gate
        run: |
          python scripts/gate.py \
            --policy policy/gate.yml \
            --bandit bandit.json \
            --pip-audit pip-audit.json \
            --gitleaks gitleaks.json \
            --out gate-report.md || echo "GATE_FAILED=true" >> $GITHUB_OUTPUT

      - name: Upload Gate Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-gate-report
          path: gate-report.md

      # ---------- PR Comment (developer-friendly) ----------
      - name: Comment report on PR (optional)
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/comment_report.py \
            --report gate-report.md \
            --pr "${{ github.event.pull_request.number }}" \
            --repo "${{ github.repository }}" \
            || true

      # ---------- Fail workflow if gate failed ----------
      - name: Fail if security issues found
        if: steps.gate.outputs.GATE_FAILED == 'true'
        run: exit 1
